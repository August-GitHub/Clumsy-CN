name: Build clumsy

on:
  release:
    types: [ created ]
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest

    strategy:
      matrix:
        arch: [x86, x64]
        conf: [Release]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.9.1

      - name: Build with Zig
        run: |
          zig build -Darch=${{ matrix.arch }} -Dconf=${{ matrix.conf }}

      - name: Prepare artifacts
        shell: bash
        run: |
          ARCH_TAG="${{ matrix.arch }}"
          CONF_TAG="${{ matrix.conf }}"
          
          # 转换为更明确的架构名称
          if [ "$ARCH_TAG" = "x86" ]; then
            ARCH_NAME="x86-32"
          elif [ "$ARCH_TAG" = "x64" ]; then
            ARCH_NAME="x86-64"
          else
            ARCH_NAME="$ARCH_TAG"
          fi
          
          OUT_DIR="zig-out/${ARCH_TAG}_${CONF_TAG}_A"
          ZIP_NAME="clumsy-${ARCH_NAME}-${CONF_TAG}.zip"
          
          if [ -d "$OUT_DIR" ]; then
            cd "$OUT_DIR"
            7z a -tzip "../$ZIP_NAME" *
            cd ../..
            echo "Created $ZIP_NAME"
          else
            echo "Directory $OUT_DIR not found!"
            ls -la zig-out/ 2>/dev/null || echo "zig-out directory does not exist"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clumsy-${{ matrix.arch == 'x86' && 'x86-32' || 'x86-64' }}-${{ matrix.conf }}
          path: zig-out/clumsy-${{ matrix.arch == 'x86' && 'x86-32' || 'x86-64' }}-${{ matrix.conf }}.zip
          if-no-files-found: error

      - name: Upload release assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: zig-out/clumsy-${{ matrix.arch == 'x86' && 'x86-32' || 'x86-64' }}-${{ matrix.conf }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
